{"version":3,"sources":["../../../../src/server/data/getAuthDataFromRequest.ts"],"sourcesContent":["import type { AuthObject } from '@clerk/backend';\nimport type { AuthenticateRequestOptions, SignedInAuthObject, SignedOutAuthObject } from '@clerk/backend/internal';\nimport {\n  authenticatedMachineObject,\n  AuthStatus,\n  constants,\n  getAuthObjectFromJwt,\n  getMachineTokenType,\n  isMachineToken,\n  isTokenTypeAccepted,\n  signedOutAuthObject,\n  TokenType,\n  unauthenticatedMachineObject,\n  verifyMachineAuthToken,\n} from '@clerk/backend/internal';\nimport { decodeJwt } from '@clerk/backend/jwt';\nimport type { PendingSessionOptions } from '@clerk/types';\n\nimport type { LoggerNoCommit } from '../../utils/debugLogger';\nimport { API_URL, API_VERSION, PUBLISHABLE_KEY, SECRET_KEY } from '../constants';\nimport { getAuthKeyFromRequest, getHeader } from '../headers-utils';\nimport type { RequestLike } from '../types';\nimport { assertTokenSignature, decryptClerkRequestData } from '../utils';\n\nexport type GetAuthDataFromRequestOptions = {\n  secretKey?: string;\n  logger?: LoggerNoCommit;\n  acceptsToken?: AuthenticateRequestOptions['acceptsToken'];\n} & PendingSessionOptions;\n\nexport const getAuthDataFromRequestSync = (\n  req: RequestLike,\n  { treatPendingAsSignedOut = true, ...opts }: GetAuthDataFromRequestOptions = {},\n): SignedInAuthObject | SignedOutAuthObject => {\n  const { authStatus, authMessage, authReason, authToken, authSignature } = getAuthHeaders(req);\n\n  opts.logger?.debug('headers', { authStatus, authMessage, authReason });\n\n  const encryptedRequestData = getHeader(req, constants.Headers.ClerkRequestData);\n  const decryptedRequestData = decryptClerkRequestData(encryptedRequestData);\n\n  const options = {\n    secretKey: opts?.secretKey || decryptedRequestData.secretKey || SECRET_KEY,\n    publishableKey: decryptedRequestData.publishableKey || PUBLISHABLE_KEY,\n    apiUrl: API_URL,\n    apiVersion: API_VERSION,\n    authStatus,\n    authMessage,\n    authReason,\n    treatPendingAsSignedOut,\n  };\n\n  // Only accept session tokens in the synchronous version.\n  // Machine tokens are not supported in this function. Any machine token input will result in a signed-out state.\n  if (!isTokenTypeAccepted(TokenType.SessionToken, opts.acceptsToken || TokenType.SessionToken)) {\n    return signedOutAuthObject(options);\n  }\n\n  let authObject;\n  if (!authStatus || authStatus !== AuthStatus.SignedIn) {\n    authObject = signedOutAuthObject(options);\n  } else {\n    assertTokenSignature(authToken as string, options.secretKey, authSignature);\n\n    const jwt = decodeJwt(authToken as string);\n\n    opts.logger?.debug('jwt', jwt.raw);\n\n    return getAuthObjectFromJwt(jwt, options);\n  }\n\n  return authObject;\n};\n\n/**\n * Note: We intentionally avoid using interface/function overloads here since these functions\n * are used internally. The complex type overloads are more valuable at the public API level\n * (like in auth.protect(), auth()) where users interact directly with the types.\n *\n * Given a request object, builds an auth object from the request data. Used in server-side environments to get access\n * to auth data for a given request.\n */\nexport const getAuthDataFromRequestAsync = async (\n  req: RequestLike,\n  opts: GetAuthDataFromRequestOptions = {},\n): Promise<AuthObject> => {\n  const { authStatus, authMessage, authReason } = getAuthHeaders(req);\n\n  opts.logger?.debug('headers', { authStatus, authMessage, authReason });\n\n  const bearerToken = getHeader(req, constants.Headers.Authorization)?.replace('Bearer ', '');\n  const acceptsToken = opts.acceptsToken || TokenType.SessionToken;\n\n  if (bearerToken && isMachineToken(bearerToken)) {\n    const tokenType = getMachineTokenType(bearerToken);\n\n    const options = {\n      secretKey: opts?.secretKey || SECRET_KEY,\n      publishableKey: PUBLISHABLE_KEY,\n      apiUrl: API_URL,\n      authStatus,\n      authMessage,\n      authReason,\n    };\n\n    if (!isTokenTypeAccepted(tokenType, acceptsToken)) {\n      return unauthenticatedMachineObject(tokenType, options);\n    }\n\n    // TODO(Rob): Cache the result of verifyMachineAuthToken\n    const { data, errors } = await verifyMachineAuthToken(bearerToken, options);\n    if (errors) {\n      return unauthenticatedMachineObject(tokenType, options);\n    }\n\n    return authenticatedMachineObject(tokenType, bearerToken, data);\n  }\n\n  return getAuthDataFromRequestSync(req, opts);\n};\n\nconst getAuthHeaders = (req: RequestLike) => {\n  const authStatus = getAuthKeyFromRequest(req, 'AuthStatus');\n  const authToken = getAuthKeyFromRequest(req, 'AuthToken');\n  const authMessage = getAuthKeyFromRequest(req, 'AuthMessage');\n  const authReason = getAuthKeyFromRequest(req, 'AuthReason');\n  const authSignature = getAuthKeyFromRequest(req, 'AuthSignature');\n\n  return {\n    authStatus,\n    authToken,\n    authMessage,\n    authReason,\n    authSignature,\n  };\n};\n"],"mappings":";AAEA;AAAA,EACE;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,OACK;AACP,SAAS,iBAAiB;AAI1B,SAAS,SAAS,aAAa,iBAAiB,kBAAkB;AAClE,SAAS,uBAAuB,iBAAiB;AAEjD,SAAS,sBAAsB,+BAA+B;AAQvD,MAAM,6BAA6B,CACxC,KACA,EAAE,0BAA0B,MAAM,GAAG,KAAK,IAAmC,CAAC,MACjC;AAjC/C;AAkCE,QAAM,EAAE,YAAY,aAAa,YAAY,WAAW,cAAc,IAAI,eAAe,GAAG;AAE5F,aAAK,WAAL,mBAAa,MAAM,WAAW,EAAE,YAAY,aAAa,WAAW;AAEpE,QAAM,uBAAuB,UAAU,KAAK,UAAU,QAAQ,gBAAgB;AAC9E,QAAM,uBAAuB,wBAAwB,oBAAoB;AAEzE,QAAM,UAAU;AAAA,IACd,YAAW,6BAAM,cAAa,qBAAqB,aAAa;AAAA,IAChE,gBAAgB,qBAAqB,kBAAkB;AAAA,IACvD,QAAQ;AAAA,IACR,YAAY;AAAA,IACZ;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,EACF;AAIA,MAAI,CAAC,oBAAoB,UAAU,cAAc,KAAK,gBAAgB,UAAU,YAAY,GAAG;AAC7F,WAAO,oBAAoB,OAAO;AAAA,EACpC;AAEA,MAAI;AACJ,MAAI,CAAC,cAAc,eAAe,WAAW,UAAU;AACrD,iBAAa,oBAAoB,OAAO;AAAA,EAC1C,OAAO;AACL,yBAAqB,WAAqB,QAAQ,WAAW,aAAa;AAE1E,UAAM,MAAM,UAAU,SAAmB;AAEzC,eAAK,WAAL,mBAAa,MAAM,OAAO,IAAI;AAE9B,WAAO,qBAAqB,KAAK,OAAO;AAAA,EAC1C;AAEA,SAAO;AACT;AAUO,MAAM,8BAA8B,OACzC,KACA,OAAsC,CAAC,MACf;AArF1B;AAsFE,QAAM,EAAE,YAAY,aAAa,WAAW,IAAI,eAAe,GAAG;AAElE,aAAK,WAAL,mBAAa,MAAM,WAAW,EAAE,YAAY,aAAa,WAAW;AAEpE,QAAM,eAAc,eAAU,KAAK,UAAU,QAAQ,aAAa,MAA9C,mBAAiD,QAAQ,WAAW;AACxF,QAAM,eAAe,KAAK,gBAAgB,UAAU;AAEpD,MAAI,eAAe,eAAe,WAAW,GAAG;AAC9C,UAAM,YAAY,oBAAoB,WAAW;AAEjD,UAAM,UAAU;AAAA,MACd,YAAW,6BAAM,cAAa;AAAA,MAC9B,gBAAgB;AAAA,MAChB,QAAQ;AAAA,MACR;AAAA,MACA;AAAA,MACA;AAAA,IACF;AAEA,QAAI,CAAC,oBAAoB,WAAW,YAAY,GAAG;AACjD,aAAO,6BAA6B,WAAW,OAAO;AAAA,IACxD;AAGA,UAAM,EAAE,MAAM,OAAO,IAAI,MAAM,uBAAuB,aAAa,OAAO;AAC1E,QAAI,QAAQ;AACV,aAAO,6BAA6B,WAAW,OAAO;AAAA,IACxD;AAEA,WAAO,2BAA2B,WAAW,aAAa,IAAI;AAAA,EAChE;AAEA,SAAO,2BAA2B,KAAK,IAAI;AAC7C;AAEA,MAAM,iBAAiB,CAAC,QAAqB;AAC3C,QAAM,aAAa,sBAAsB,KAAK,YAAY;AAC1D,QAAM,YAAY,sBAAsB,KAAK,WAAW;AACxD,QAAM,cAAc,sBAAsB,KAAK,aAAa;AAC5D,QAAM,aAAa,sBAAsB,KAAK,YAAY;AAC1D,QAAM,gBAAgB,sBAAsB,KAAK,eAAe;AAEhE,SAAO;AAAA,IACL;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,EACF;AACF;","names":[]}